+++
title = "Flask åˆ° Gin â€”â€” è¯»å–é…ç½®æ–‡ä»¶"
postid = 2684
date = 2020-01-01T20:59:52+08:00
isCJKLanguage = true
toc = true
type = "post"
slug = "flask-to-gin-read-config-file"
aliases = [ "/post/2684.html",]
category = [ "technology",]
tag = [ "fromto", "flask", "golang", "python", "gin", "mjp"]
+++

æœ¬æ–‡æ˜¯ [ä» Flask åˆ° Gin](/post/flask-to-gin-index/) ç³»åˆ—çš„ç¬¬ 3 ç¯‡ã€‚

----

é…ç½®æ–‡ä»¶æ˜¯ä¸€ä¸ªé¡¹ç›®ä¸å¯æˆ–ç¼ºçš„å†…å®¹ã€‚åœ¨ [MJP](/tag/mjp/) çš„ Flask ç‰ˆæœ¬ä¸­ï¼Œæˆ‘é‡‡ç”¨ JSON æ ¼å¼çš„é…ç½®æ–‡ä»¶ã€‚åœ¨ Gin çš„å®ç°ä¸­ï¼Œæˆ‘å†³å®šä¿æŒè¿™ç§æ ¼å¼ä¸å˜ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€åŒ–äº†çš„é…ç½®æ–‡ä»¶å†…å®¹ã€‚ <!--more-->

## é…ç½®æ–‡ä»¶èŒƒä¾‹

``` json
{
  "GIN_MODE": "debug",
  "PATH": "",
  "ADDRESS": "127.0.0.1:5005",
  "SECRET_KEY": "YutjgVSPDERGyPayXrXbwsuF_SZWiVmUw3mD4YYD_kY=",
  "DATABASES": {
    "DATABASE_URI": "zrong:123456@(127.0.0.1)/data1?charset=utf8mb4&parseTime=True&loc=Local",
    "DATABASE_BINDS": {
      "data1": "zrong:123456@(127.0.0.1)/data1?charset=utf8mb4&parseTime=True&loc=Local",
      "data2": "zrong:123456@(127.0.0.1)/data2?charset=utf8mb4&parseTime=True&loc=Local"
    }
  },
  "REGIONALS": [
    {
      "name": "æµ‹è¯•æœ1001",
      "r": 1001,
      "bind_key_db": "mjptest"
    },
    {
      "name": "æµ‹è¯•æœ1023",
      "r": 1023,
      "bind_key_db": "mjptest"
    }
  ]
}
```

ä¸Šé¢çš„é…ç½®æ–‡ä»¶å‘½åä¸º `config.json`ï¼Œä¿å­˜åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ã€‚

## é…ç½®æ¨¡å—å°è£…ï¼šconfig.py

ä¸‹é¢æ˜¯ Flask é¡¹ç›®ä¸­ï¼Œå¯¹ `config.json` è¿™ä¸ªé…ç½®æ–‡ä»¶è¿›è¡Œå¤„ç†çš„æ¨¡å—ã€‚æ¨¡å—åç§°æ˜¯ `config.py`ã€‚è¿™ä¸ªæ¨¡å—çš„ä¸»è¦åŠŸèƒ½æœ‰ä¸‹é¢å‡ ä¸ªï¼š

1. æä¾›ä¸€ä¸ª `getdir` æ¨¡å—æ–¹æ³•ï¼Œç”¨äºè¿”å›å½“å‰æ–‡ä»¶å¤¹ä¸‹ç›¸å¯¹è·¯å¾„çš„ `Path` å¯¹è±¡ã€‚
2. è§£æ `config.json`ï¼Œå°†å…¶ä¿å­˜åˆ°æ¨¡å—å…¨å±€å˜é‡ä¸­ï¼Œä¾¿äºéšæ—¶ä½¿ç”¨ã€‚è¿™é‡Œä½¿ç”¨æ ‡å‡†åº“çš„ `json` åŒ…å®Œæˆï¼Œå¹¶å°è£…äº†ä¸€ä¸ª `readjson` æ–¹æ³•ã€‚
3. å°è£…äº†ä¸€ä¸ª `getcfg` æ¨¡å—æ–¹æ³•ï¼Œä»é…ç½®æ–‡ä»¶ä¸­è·å–å˜é‡ã€‚
4. å°è£…äº†ä¸€ä¸ª `getregional` æ¨¡å—æ–¹æ³•ï¼Œæ ¹æ® `REGIONAL` ä¸­çš„ `r` å€¼ï¼Œè·å–è¿™ä¸ª `r` å¯¹åº”çš„é…ç½®ã€‚

``` python
# -*- coding: utf-8 -*-
"""
config.py
~~~~~~~~~~~~~~~~~~~

åˆå§‹åŒ– app.config ä¸­çš„é…ç½®
è§£æ config.json é…ç½®æ–‡ä»¶
æä¾›é…ç½®æ–‡ä»¶ç›¸å…³çš„è¯»å–å’Œå†™å…¥æ–¹æ³•
"""

import os
from pathlib import Path
import json


# getdir ä½¿ç”¨
__basedir = None

# å…¨å±€å˜é‡ï¼Œç”¨äºä¿å­˜ config.json è½½å…¥çš„é…ç½®
cfg_json = None

regional_list = None
regional_dict = {}
regional_ids = []


def readjson(filename, basedir=None, throw_error=False):
    """ è¯»å–ä¸€ä¸ª json æ ¼å¼çš„é…ç½®æ–‡ä»¶

    :param filename: æ–‡ä»¶å
    :param basedir: str
    :param throw_error: boolean è‹¥å€¼ä¸º Trueï¼Œåˆ™å½“æ–‡ä»¶ä¸å­˜åœ¨çš„æ—¶å€™æŠ›å‡ºå¼‚å¸¸
    :returns: è§£æåçš„ dict
    :rtype: dict
    """
    jsonf = getdir(filename, basedir=basedir)
    if jsonf.exists():
        return json.loads(jsonf.read_text(encoding='utf-8'), encoding='utf-8')
    if throw_error:
        raise FileNotFoundError('%s is not found!' % jsonf.resolve())
    return {}


def writejson(data_dict, filename, basedir=None):
    """ å°†ä¸€ä¸ª dict å†™å…¥æˆä¸º json æ–‡ä»¶

    :param data_dict: è¦å†™å…¥çš„é…ç½®ä¿¡æ¯
    :type data_dict: dict
    """
    jsonf = getdir(filename, basedir=basedir)
    jsonf.write_text(json.dumps(data_dict, ensure_ascii=False, indent=2))
        

def getdir(*args, basedir=None):
    """ åŸºäºå½“å‰é¡¹ç›®çš„è¿è¡Œæ–‡ä»¶å¤¹ï¼Œè¿”å›ä¸€ä¸ª pathlib.Path å¯¹è±¡
    å¦‚æœä¼ é€’ basedirï¼Œå°±åŸºäºè¿™ä¸ª basedir åˆ›å»ºè·¯å¾„
    """
    if basedir is not None:
        return Path(basedir, *args)
    if __basedir is None:
        raise ValueError('please set basedir first!')
    return Path(__basedir, *args)


def getcfg(*args, default_value=None, data='cfg_json'):
    """
    é€’å½’è·å– dict ä¸­çš„å€¼
    å¦‚æœä¸æä¾› dataï¼Œé»˜è®¤ä½¿ç”¨ cfg ä¸­çš„å€¼
    æ³¨æ„ï¼Œgetcfg ä¸ä»…å¯ç”¨äºè¯»å– config.yaml çš„å€¼ï¼Œè¿˜å¯ä»¥é€šè¿‡ä¼ é€’ data ç”¨äºè¯»å–ä»»ä½•å­—å…¸çš„å€¼
    :param args:
    :param data:
    :return:
    """
    if data is None:
        return None
    elif data == 'cfg_json':
        data = cfg_json
    if args:
        if isinstance(data, dict):
            return getcfg(*args[1:], data=data.get(args[0], default_value))
        return data
    return data


def init_regionals():
    global regional_list
    # ä»é…ç½®æ–‡ä»¶ä¸­è¯»å– regional çš„é…ç½®ï¼Œå­˜å‚¨åˆ°ä¸€ä¸ª list å’Œä¸€ä¸ª dict ä¸­
    regional_list = getcfg('REGIONALS')
    if not isinstance(regional_list, list) or len(regional_list) == 0:
        raise ValueError('REGIONAL is unavailable!')
    for regional in regional_list:
        r = regional.get('r')
        if r is None:
            raise KeyError('REGIONALS é…ç½®å¿…é¡»åŒ…å« r key!')
        regional_ids.append(r)
        regional_dict[r] = regional


def getregional(r):
    return regional_dict.get(r)


def init(basedir=None, initr=True):
    """ åˆå§‹åŒ–é…ç½®æ–‡ä»¶
    :param initr: æ˜¯å¦åˆå§‹åŒ–é…ç½®æ–‡ä»¶ä¸­çš„ initregionals
    """
    global __basedir, cfg_json
    if basedir is None:
        __basedir = os.getcwd()
    else:
        __basedir = basedir
    cfg_json = readjson('config.json')
    if initr:
        init_regionals()
```

ä½¿ç”¨æ–¹æ³•å¾ˆç®€å•ï¼Œå¯¼å…¥å…¨å±€æ¨¡å— configï¼Œè°ƒç”¨å…¶å°è£…çš„æ–¹æ³•å³å¯ï¼š

``` python
from mjp import config

address = config.getcfg('ADDRESS')
```

æ˜¾ç„¶ï¼Œç”±äº Python çš„åŠ¨æ€ç‰¹æ€§ï¼Œå°† `config.json` è§£æåå˜æˆä¸€ä¸ª `dict`ï¼Œç„¶åå¤„ç†å®ƒï¼Œæ˜¯ä¸€ä»¶å¾ˆçµæ´»å’Œè½»æ¾çš„äº‹æƒ…ã€‚ä½† Golang æ˜¯é™æ€è¯­è¨€ï¼Œå¤„ç†èµ·æ¥å¹¶æ²¡æœ‰è¿™ä¹ˆæ–¹ä¾¿ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥å¤ä¹ ä¸€ä¸‹ [ä» Flask åˆ° Gin â€”â€” å¤„ç† JSON](/post/flask-to-gin-json/)ï¼Œ`config.json` éœ€è¦æ˜ å°„æˆ Struct æ‰æ›´å®¹æ˜“ä½¿ç”¨ã€‚

æ¥ä¸‹æ¥çœ‹çœ‹æ€æ ·åœ¨ Golang ä¸­å®ç°å’Œ `config.py` æ¨¡å—ç±»ä¼¼çš„æ•ˆæœã€‚

## ä½¿ç”¨ viper è¯»å–é…ç½®

ç¬¬ä¸€æ¬¡çœ‹åˆ° [viper](https://github.com/spf13/viper)ï¼Œæ˜¯å› ä¸º [Hugo](https://gohugo.io/)ã€‚å»å¹´ 8 æœˆï¼Œæˆ‘æŠŠåšå®¢ä» [Hexo è½¬åˆ°äº† Hugo](/post/hexo-to-hugo/)ï¼Œæ¥ç€åšå®šäº†å­¦ä¹  Golang çš„å¿µå¤´ã€‚Hugo ä½¿ç”¨ viper ä¹Ÿå¾ˆæ­£å¸¸ï¼Œå› ä¸º viper çš„ä½œè€… spf13 ä¹Ÿæ˜¯ Hugo çš„ä¸»è¦ä½œè€…ä¹‹ä¸€ã€‚

æˆ‘åˆšä½¿ç”¨ Hugo çš„æ—¶å€™ï¼Œå°±å› ä¸ºå®ƒåŒæ—¶æ”¯æŒå¤šç§é…ç½®æ–‡ä»¶æ ¼å¼ `config.yaml/config.toml/config.json` è€Œæ„Ÿåˆ°æƒŠè®¶ï¼ˆå½“ç„¶ï¼Œ[uWSGI](https://uwsgi-docs.readthedocs.io/en/latest/) ä¹Ÿæ˜¯æ”¯æŒå¤šç§é…ç½®æ–‡ä»¶æ ¼å¼çš„ï¼Œæ‰€ä»¥æˆ‘å¯èƒ½ä¹Ÿå¹¶æ²¡æœ‰é‚£ä¹ˆæƒŠè®¶ğŸ˜„ï¼‰ï¼Œæˆ‘ä¹Ÿæ˜¯åœ¨è¿™é‡Œç¬¬ä¸€æ¬¡æ¥è§¦åˆ°äº† [TOML](https://github.com/toml-lang/toml) æ ¼å¼ã€‚

viper çš„ä¼˜åŠ¿å¾ˆå¤šï¼ˆ[via](viperdo)ï¼‰ï¼š

- ä¸ºå„ç§é…ç½®é¡¹è®¾ç½®é»˜è®¤å€¼
- åŠ è½½å¹¶è§£æJSONã€TOMLã€YAML æˆ– Java properties æ ¼å¼çš„é…ç½®æ–‡ä»¶
- å¯ä»¥ç›‘è§†é…ç½®æ–‡ä»¶çš„å˜åŠ¨ã€é‡æ–°è¯»å–é…ç½®æ–‡ä»¶
- ä»ç¯å¢ƒå˜é‡ä¸­è¯»å–é…ç½®æ•°æ®
- ä»è¿œç«¯é…ç½®ç³»ç»Ÿä¸­è¯»å–æ•°æ®ï¼Œå¹¶ç›‘è§†å®ƒä»¬
- ä»å‘½ä»¤å‚æ•°ä¸­è¯»å–é…ç½®
- ä» buffer ä¸­è¯»å–
- è°ƒç”¨å‡½æ•°è®¾ç½®é…ç½®ä¿¡æ¯

å› ä¸ºè¿™äº›ä¼˜åŠ¿ï¼Œæˆ‘é€‰æ‹©äº† viper ä½œä¸ºé…ç½®æ–‡ä»¶çš„è¯»å–å’Œè§£æåº“ã€‚

## é…ç½®æ¨¡å—å°è£…ï¼šconfig.go

ä¸‹é¢æ˜¯ Gin é¡¹ç›®ä¸­ï¼Œå¯¹ `config.json` è¿™ä¸ªé…ç½®æ–‡ä»¶è¿›è¡Œå¤„ç†çš„æ¨¡å—ã€‚æ¨¡å—åç§°æ˜¯ `config.go`ã€‚è¿™ä¸ªæ¨¡å—çš„ä¸»è¦åŠŸèƒ½æœ‰ä¸‹é¢å‡ ä¸ªï¼š

1. æä¾›ä¸€ä¸ª `GetDir` å‡½æ•°ï¼Œç”¨äºè¿”å›å½“å‰æ–‡ä»¶å¤¹ä¸‹çš„ç›¸å¯¹è·¯å¾„ã€‚
2. è§£æ `config.json`ï¼Œå°†å…¶å†…å®¹æ˜ å°„åˆ° `Config` è¿™ä¸ª Struct ä¸­ï¼Œä¾¿äºéšæ—¶ä½¿ç”¨ã€‚
3. å°è£…äº† `DatabaseBind` å‡½æ•°ï¼Œä»é…ç½®æ–‡ä»¶ä¸­è·å–æ•°æ®åº“ç»‘å®šæƒ…å†µã€‚
4. å°è£…äº†ä¸€ä¸ª `Regional` å‡½æ•°ï¼Œæ ¹æ® `REGIONAL` ä¸­çš„ `r` å€¼ï¼Œè·å–è¿™ä¸ª `r` å¯¹åº”çš„ `Regional` Structã€‚

``` go
package util

import (
	"encoding/json"
	"fmt"
	"os"
	"path"
	"path/filepath"
	"sync"

	"github.com/gin-gonic/gin"
	"github.com/spf13/viper"
)

// Databases å®šä¹‰é…ç½®ä¸­çš„ DATABASES å­—æ®µ
type Databases struct {
	URI   string            `mapstructure:"DATABASE_URI"`
	Binds map[string]string `mapstructure:"DATABASE_BINDS"`
}

// Regional å®šä¹‰ä¸€ä¸ªåŒºæœçš„é…ç½®
type Regional struct {
	Name      string `mapstructure:"name"`
	R         int    `mapstructure:"r"`
	BindKeyDb string `mapstructure:"bind_key_db"`
}

// String return a string about regional
func (regional *Regional) String() string {
	return regional.Name
}

/*
Config parse form config.json
*/
type Config struct {
	GinMode   string      `mapstructure:"GIN_MODE"`
	Path      string      `mapstructure:"PATH"`
	Address   string      `mapstructure:"ADDRESS"`
	SecretKey string      `mapstructure:"SECRET_KEY"`
	Databases *Databases  `mapstructure:"DATABASES"`
	Regionals []*Regional `mapstructure:"REGIONALS"`
}

// String return the config as string
func (conf *Config) String() string {
	c := viper.AllSettings()
	bs, err := json.Marshal(c)
	if err != nil {
		fmt.Println(err)
	}
	return string(bs)
}

// Regional return a regional in REGIONALS
func (conf *Config) Regional(r int) *Regional {
	return regionals[r]
}

// DatabaseBind return a database_uri in DATABASES
func (conf *Config) DatabaseBind(bindKey string) string {
	return conf.Databases.Binds[bindKey]
}

var regionals map[int]*Regional
var conf *Config
var configOnce sync.Once

// load the config.json and return it
func load(content string) (*Config, error) {
	config := &Config{}

	var err error

	viper.SetConfigFile(content)
	err = viper.ReadInConfig()
	if err != nil {
		return nil, err
	}

	err = viper.Unmarshal(&config)
	if err != nil {
		return nil, err
	}
	regionals = make(map[int]*Regional)
	for _, value := range config.Regionals {
		regionals[value.R] = value
	}

	return config, nil
}

// ConfigInstance is a signal Config
func ConfigInstance() *Config {
	configOnce.Do(func() {
		configFile := GetDir("config.json")
		inst, err := load(configFile)
		if err != nil {
			panic(err)
		}
		conf = inst
		if conf.GinMode != "" {
			gin.SetMode(conf.GinMode)
		}
	})
	return conf
}

// GetDir return a path in pwd
func GetDir(elem ...string) string {
	curPath, _ := filepath.Abs(filepath.Dir(os.Args[0]))
	args := append([]string{curPath}, elem...)
	return path.Join(args...)
}
```

ä¸Šé¢çš„å¤„ç†å’Œ Python æœ‰å¾ˆå¤§çš„ä¸åŒã€‚åœ¨ `config.py` ä¸­ï¼Œæ‰€æœ‰è¯»å…¥å†…å­˜çš„é…ç½®æ–‡ä»¶æ•°æ®ä½œä¸ºä¸€ä¸ª `dict` å­˜åœ¨ï¼Œè¦è·å–å…¶ä¸­çš„å€¼ï¼Œåªéœ€è¦ä½¿ç”¨ `dict.get` å¹¶æä¾›å€¼çš„åç§°å³å¯ã€‚ä½†æ˜¯åœ¨ `config.go` ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»æŠŠæ‰€æœ‰çš„å€¼ä»¥ Struct çš„å½¢å¼è¿›è¡Œé¢„å…ˆå®šä¹‰å’Œç»‘å®šã€‚

çœ‹çœ‹æ€ä¹ˆä½¿ç”¨ `config.go`ï¼š

``` go
package middlewares

import (
	"mjp/util"
	"github.com/gin-gonic/gin"
)
var config *util.Config
var logger *util.Logger

func init() {
    config = util.ConfigInstance()
    logger = util.GetAppLogger()
}

func printAddress() {
    logger.Infof("Addrss: %s", config.Address)
}
```

## å‚è€ƒ

- [åœ¨ Go ä¸­ä½¿ç”¨ Viper åŠ è½½é…ç½®æ–‡ä»¶][viperdo]

[viperdo]: https://blog.biezhi.me/2018/10/load-config-with-viper.html

----

é˜…è¯»ç³»åˆ—æ‰€æœ‰æ–‡ç« ï¼š[ä» Flask åˆ° Gin](/post/flask-to-gin-index/)ã€‚

{{<label å…¨æ–‡å®Œ info>}}