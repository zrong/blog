+++
title = "双控智能灯具的实现"
postid = 2721
date = 2020-07-26T17:27:21+08:00
isCJKLanguage = true
toc = true
type = "post"
slug = "dual-control-intelligent-lamps"
aliases = [ "/post/2721.html",]
category = [ "use",]
tag = [ "live", "xiaomi" ]
thumbnail = "/uploads/2020/07/mihome1.jpg"
+++

一直以来我都是个米粉，家中和公司都使用了大量的小米生态链的智能设备。大部分设备的安装和使用都相当简单，也有些需要一点点技巧。这篇就谈谈怎么实现智能灯具的单开双控。

注意，**本篇不是广告，我没有收小米一分钱**。但其中涉及到的所有产品均来自小米生态链。

实现智能灯具控制，要解决的核心问题是保证灯具始终在线，这样才允许同时使用开关、手机、或者语音助手等对灯具进行唤醒。 <!--more-->

## 智能灯具是如何工作的

智能灯具自身包含网关和照明两个模块，网关部分的功能是保持与 WIFI 的连接，接收互联网发来的开关、调整色温和光强等信号。照明模块则与普通灯具的照明部分一致。

因此，智能灯具的网关模块是不允许断电的，否则就无法与互联网连接，照明模块的电源由网关模块来控制。

问题来了，智能灯具中的网关会 24 小时耗电？

是的。

好在网关的耗电量很小。或许你一次忘记关灯后消耗的电量，都会大于网关几个月消耗的电量。

浪费和便利性，你选哪个？

## 不同的智能灯具方案

有几套方案可以选择：

- 方案一：智能灯具+传统墙壁开关
- 方案二：智能灯具+传统墙壁开关+智能无线开关
- 方案三：普通灯具+智能墙壁开关
- 方案四：智能灯具+智能墙壁开关
- 方案五：智能灯具+米家墙壁开关（支持灵动开关功能）

**方案一** 适用于要传统灯具损坏，直接更换成智能灯具，但不希望更换传统墙壁开关的情况。这种方案的问题在于，传统墙壁开关关闭时会对灯具进行断电，导致智能灯具离线，此时就无法使用手机或者语音助手对灯具进行控制了。

**方案二** 是方案一的变体。如果锁死传统墙壁开关的开状态，直接用手机、语音助手、无线开关（一般是 Zigbee 协议，例如绿米Aqara无线开关 D1 贴墙式、绿米 Aqara 无线开关升级版）控制智能灯具的开关，是可以解决智能灯具离线问题的。但这样势必会修改旧的使用习惯，而且也需要另外购置 Zigbee 网关和无线开关。

**方案三** 适用于保留传统灯具，将传统墙壁开关换成智能墙壁开关的情况。可以节省购买灯具的费用（毕竟主灯总比开关贵）。这看起来是很完美的方案，但根据我的经验，问题很多：

1. 智能墙壁开关需要零线，而一般的装修布线不会为灯具单独铺设零线。
2. 智能墙壁开关有单火版本（不需要零线），但单火版本的故障率较高（或者说兼容性较差）。我购买过绿米 Aqara 墙壁开关（单火版），配合普通灯具使用时，凌晨时分灯具经常会无故闪亮，还蛮恐怖的。
3. 智能墙壁开关的价格较高，大概是传统墙壁开关的 10 倍以上。
4. 绿米的 Aqara 智能墙壁开关使用的是 ZigBee 协议，需要配合 ZigBee 网关使用，无疑又增加了费用。

**方案四** 有点浪费，因为智能灯具和智能墙壁开关都比传统设备贵。如果是新装修，选择方案三（预留零线）或者方案五都比较好。

**方案五** 是我目前使用的方案。这个方案有如下优势：

1. 米家的许多智能灯具都自带蓝牙 Mesh 网关，这样在每个房间里安装蓝牙 Mesh 设备（米家蓝牙湿温度计，米家保险箱，米家LED灯泡蓝牙 Mesh 版，米家智能插座蓝牙网关版）的时候，就不需要再单独购买网关了。因为蓝牙协议的通信距离有限，把蓝牙 Mesh 网关做在灯具里是最合适的选择，每个房间都可以覆盖蓝牙信号。
2. 传统灯具和智能灯具可以共存。
3. 米家墙壁开关不是智能墙壁开关，而是传统墙壁开关。它可以用于控制传统灯具，也可以控制支持「灵动开关」功能的智能灯具。如果只希望将部分传统灯具换成智能灯具，这个特性就很有用。例如我的客厅门灯就是传统灯具，客厅主灯为智能灯具，这两个灯具的原始布线是接在一个「传统二开墙壁开关」上的。我只需要购买一个二开米家墙壁开关，其中一个设置为传统跷板模式接传统灯具，另一个设置为自回弹模式接智能灯具，就可以在一个墙壁开关上同时完美兼容传统灯具和智能灯具了。
4. 米家墙壁开关的价格不算贵，大约是传统墙壁开关的两到三倍，做工真心不错。

![米家](/uploads/2020/07/mihome1.jpg)

SAGITEAM 的智能设备

![智能灯具带蓝牙网关](/uploads/2020/07/mihome2.jpg)

智能灯具带蓝牙网关

## 对智能灯具实现单开双控

下面的这个例子，是将单开双控的普通顶灯，切换为米家吸顶灯 450，并使用米家墙壁开关实现单开双控。

单开双控，就是使用两个单独的开关（单开），控制一盏灯。其实现原理图和电路图如下：

![双控接线示意图](/uploads/2020/07/c2.jpg)

由于之前的传统开关是单开，我购买的米家墙壁开关也是单开。与传统墙壁开关区分单控和双控不同，米家墙壁开关同时支持单控和双控。

传统开关的接线如下图：

![传统开关的接线](/uploads/2020/07/mihome4.jpg)

上图中，上下两根黄色线分别为 L1/L2，中间的绿色线为 L。根据双控原理图，我们知道在两个传统开关中，有一个开关的绿线是输入火线，另一个开关的绿色线是接灯输入火线。可以使用试电笔将它们找出来。方法是在灯具处于关闭状态的时候，始终有电的那根绿色线就是输入火线，而另一个开关的绿色线就是接灯输入火线。

![双控接线说明书](/uploads/2020/07/mihome5.jpg)

根据米家墙壁开关说明书中的「双控」接线法，我们可以知道这个方法的核心是保证灯具永远处于通电状态，这样一来智能灯具就不会离线了。

具体的接线如下图所示，这是其中一个开关的接线方式，多出的那一根 L2 没有用处了，用电工胶带包好即可。

![智能开关的接线](/uploads/2020/07/mihome3.jpg)

**注意：如果第一个开关接入的是 L1，在另一个开关上，一般情况下要接入 L2。因为传统开关要保证两个开关的状态是互斥的，所以 L1 和 L2 是交叉联通状态。具体那根线是连通的，可以在通电后使用试电笔测试。一定要注意绿色线不要接错，否则可能会出现安全问题。**

## 灵动开关

![灵动开关](/uploads/2020/07/mihome6.jpg)

使用「米家」连接智能灯具之后，一定要将灯具的「灵动开关」置为开启状态，这样灯具才能识别米家墙壁开关的「自回弹」模式的信号。

我没有在互联网上找到关于智能灯具中「灵动开关」模式的过多资料，通过实验我对「灵动开关」有了一些理解，胡乱说一下。

米家墙壁开关开启了「自回弹」模式后，每次按下的时候，作用是短暂切断电源之后重开电源。如果智能灯具支持「灵动开关」并开启该功能，那么网关模块会将这次短暂断电的行为理解为要求关闭或者打开照明模块的电源。由于网关内有电容器，短暂切断电源的行为并不会让网关模块丧失功能。

**后备式 UPS** 也是利用这种机制工作的。在市电断开的时候，后备式 UPS 会在 10ms 内开始对设备供电。由于后备式 UPS 的供电一般面向的是家用 PC 机这类自带交换式电源，且对用电安全要求不高的设备，10ms 足够了。

最后，再重复一遍，上面的关于「灵动开关」的原理都是我瞎猜的。

张大妈有一篇 [0成本把普通开关改造成灵动开关](https://post.smzdm.com/p/akm7l3mr/)，用普通开关加弹簧的方式模拟小米墙壁开关的「自回弹」模式。注意，这只是解决了墙壁开关的问题，智能灯中的灵动开关支持依然是必须的。

{{<label 全文完 info>}}